<!DOCTYPE html>
<html lang="nl" data-theme="light" data-color="red">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Many to Many (BelongsToMany)</title>

    <script src="../../../../assets/js/theme-init.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="../../../../assets/css/style.css">
</head>
<body>

<div data-include="../../../../components/header.html"></div>

<div class="layout-wrapper">
    <div data-include="../../../../components/sidebar.html"></div>

    <main class="main-content">
        <h1>Many to Many (BelongsToMany)</h1>
        <p>Een veel-op-veel relatie is complexer omdat beide kanten meerdere verbindingen kunnen hebben. Een database kan dit niet direct opslaan in de tabellen zelf (zoals bij One-to-Many). We hebben een derde tabel nodig: de <strong>Pivot Tabel</strong> (tussentabel).</p>

        <p><strong>Voorbeeld:</strong></p>
        <ul>
            <li>Een <strong>User</strong> kan meerdere <strong>Roles</strong> hebben (bijv. 'Admin' én 'Editor').</li>
            <li>Een <strong>Role</strong> kan aan meerdere <strong>Users</strong> gekoppeld zijn.</li>
        </ul>

        <h2>Leeruitkomsten</h2>
        <ul style="margin-bottom: 2rem;">
            <li>Ik begrijp het concept van een veel-op-veel relatie en waarom een pivot tabel nodig is.</li>
            <li>Ik kan een pivot tabel aanmaken volgens Laravel's naamgevingsconventies.</li>
            <li>Ik kan <code>belongsToMany</code> relaties definiëren in beide models.</li>
            <li>Ik kan relaties beheren met <code>attach()</code>, <code>detach()</code>, <code>sync()</code> en <code>toggle()</code>.</li>
            <li>Ik kan data ophalen en filteren met <code>whereHas()</code>.</li>
        </ul>

        <h3>Stap 1: De Database Structuur (Pivot Tabel)</h3>
        <p>Laravel heeft strikte naamgevingsconventies voor de tussentabel:</p>
        <ol>
            <li>Neem de namen van de twee modellen (enkelvoud).</li>
            <li>Zet ze op <strong>alfabetische volgorde</strong>.</li>
            <li>Verbind ze met een underscore (<code>_</code>).</li>
        </ol>
        <p>Voor <code>User</code> en <code>Role</code> wordt dit dus: <strong><code>role_user</code></strong>.</p>

        <div class="note-box">Bestand: <code>database/migrations/xxxx_create_role_user_table.php</code></div>
        <pre><code class="language-php">
Schema::create('role_user', function (Blueprint $table) {
    // We hebben meestal geen eigen 'id' nodig, maar het mag wel.
    $table->id();

    // De twee sleutels
    $table->foreignId('user_id')->constrained()->onDelete('cascade');
    $table->foreignId('role_id')->constrained()->onDelete('cascade');

    // Zorg dat een user dezelfde rol niet 2x kan krijgen
    $table->unique(['user_id', 'role_id']);
});
        </code></pre>

        <h3>Stap 2: Relaties in Models</h3>
        <p>In een Many-to-Many relatie gebruiken beide models <code>belongsToMany</code>.</p>

        <div class="note-box">Bestand: <code>app/Models/User.php</code></div>
        <pre><code class="language-php">
use Illuminate\Database\Eloquent\Relations\BelongsToMany;

public function roles(): BelongsToMany
{
    // Laravel zoekt automatisch naar 'role_user', 'user_id' en 'role_id'
    return $this->belongsToMany(Role::class);
}
        </code></pre>

        <div class="note-box">Bestand: <code>app/Models/Role.php</code></div>
        <pre><code class="language-php">
public function users(): BelongsToMany
{
    return $this->belongsToMany(User::class);
}
        </code></pre>

        <h3>Stap 3: Koppelen (Attach)</h3>
        <p>Om een relatie te maken (een rij toevoegen in de tussentabel), gebruik je <code>attach()</code>. Je hoeft niet zelf met de <code>role_user</code> tabel te werken.</p>

        <div class="note-box">Bestand: <code>app/Http/Controllers/UserController.php</code></div>
        <pre><code class="language-php">
$user = User::find(1);
$roleId = 5;

// Voegt rol 5 toe aan deze user
$user->roles()->attach($roleId);

// Je kunt ook een array geven: voeg rol 5 en 6 toe
$user->roles()->attach([5, 6]);
        </code></pre>

        <h3>Stap 4: Ontkoppelen (Detach)</h3>
        <p>Om een relatie te verwijderen (rij weg uit tussentabel), gebruik je <code>detach()</code>.</p>
        <pre><code class="language-php">
// Verwijdert rol 5 van deze user
$user->roles()->detach($roleId);

// Verwijdert ALLE rollen van deze user
$user->roles()->detach();
        </code></pre>

        <h3>Stap 5: Synchroniseren (Sync) - *Belangrijk!*</h3>
        <p>Dit is de handigste functie voor formulieren met checkboxes. <code>sync()</code> accepteert een lijst met ID's die de gebruiker <strong>moet hebben</strong>.</p>
        <ul>
            <li>Staat een ID in de lijst maar niet in de DB? -> <strong>Attach</strong></li>
            <li>Staat een ID in de DB maar niet in de lijst? -> <strong>Detach</strong></li>
            <li>Staat hij in allebei? -> <strong>Niets doen</strong></li>
        </ul>

        <pre><code class="language-php">
// Stel in het formulier waren rol 1 en 3 aangevinkt.
// De user had misschien rol 2 en 3.
// Resultaat: Rol 2 wordt verwijderd, Rol 1 wordt toegevoegd, Rol 3 blijft.
$user->roles()->sync([1, 3]);
        </code></pre>

        <h3>Stap 6: Toggle</h3>
        <p>Soms wil je een "aan/uit" knop maken (bijv. 'Like' of 'Favoriet'). <code>toggle()</code> voegt toe als het er niet is, en verwijdert als het er wel is.</p>
        <pre><code class="language-php">
$user->roles()->toggle($roleId);
        </code></pre>

        <h3>Stap 7: Data Ophalen & Filteren</h3>
        <p>Je kunt de relaties gewoon gebruiken als eigenschap.</p>
        <pre><code class="language-php">
// Alle rollen van de user
foreach ($user->roles as $role) {
    echo $role->name;
}

// Filteren: Haal alle users op die de rol 'Admin' hebben
// We gebruiken hier 'whereHas'
$admins = User::whereHas('roles', function ($query) {
    $query->where('name', 'Admin');
})->get();
        </code></pre>
    </main>

    <aside class="sidebar-right">
        <div class="toc-container">
            <h4>Inhoud</h4>
            <ul id="toc-list" class="toc-list">
            </ul>
        </div>
    </aside>
</div>

<div data-include="../../../../components/footer.html"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="../../../../assets/js/script.js"></script>
</body>
</html>