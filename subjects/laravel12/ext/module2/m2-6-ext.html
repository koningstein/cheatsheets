<!DOCTYPE html>
<html lang="nl" data-theme="light" data-color="red">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 2-6: Controller Permissions (Uitgebreid) - Laravel 12 Module 2</title>

    <script src="../../../../assets/js/theme-init.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="../../../../assets/css/style.css">
</head>
<body>

<div data-include="../../../../components/header.html"></div>

<div class="layout-wrapper">
    <div data-include="../../../../components/sidebar.html"></div>

    <main class="main-content">
        <h1>Module 2-6: Controller Permissions</h1>

        <p class="lead">We hebben de "voordeur" beveiligd, maar Sales-medewerkers mogen nog steeds naar binnen. Helaas kunnen ze nu ook producten verwijderen, en dat is niet de bedoeling. We gaan de beveiliging fijner afstellen in de Controller.</p>

        <section class="learning-outcomes">
            <h2>Leeruitkomsten</h2>
            <p>Na het afronden van deze les kun je:</p>
            <ul>
                <li>Uitleggen wat <code>implements</code> en Interfaces doen in PHP.</li>
                <li>De <code>HasMiddleware</code> interface toepassen in een Laravel Controller.</li>
                <li>Permissies koppelen aan meerdere methodes (zoals <code>delete</code> Ã©n <code>destroy</code>).</li>
                <li>De frontend aanpassen met <code>@can</code> directives.</li>
            </ul>
        </section>

        <hr>

        <h2>Stap 1: Interface Implementeren</h2>
        <p>
            Om in Laravel 12 middleware toe te voegen aan een controller, moeten we de controller vertellen dat hij middleware mag verwachten. Dit doen we met een <strong>Interface</strong>.
        </p>

        <div class="info-box">
            <p><strong>Wat is 'implements'?</strong><br>
                Een Interface is een contract. Door te zeggen <code>implements HasMiddleware</code>, belooft jouw class: <em>"Ik heb een functie die <code>middleware()</code> heet."</em><br>
                Laravel checkt dit contract. Als de functie bestaat, wordt de beveiliging automatisch geactiveerd.</p>
        </div>

        <p>Open <code>app/Http/Controllers/Admin/CategoryController.php</code> en voeg de imports en de implementatie toe:</p>

        <pre><code class="language-php">
namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Category;
use Illuminate\Http\Request;

// BELANGRIJK: Deze 3 regels toevoegen
use Illuminate\Routing\Controllers\HasMiddleware;
use Illuminate\Routing\Controllers\Middleware;
use Spatie\Permission\Middleware\PermissionMiddleware;

// BELANGRIJK: Voeg 'implements HasMiddleware' toe
class CategoryController extends Controller implements HasMiddleware
{
    // ...
}
        </code></pre>

        <hr>

        <h2>Stap 2: Permissies Koppelen</h2>
        <p>
            Nu maken we de beloofde functie <code>middleware()</code> aan. Hier koppelen we permissies aan de methodes.
            <br>
            <strong>Let op:</strong> We hebben een aparte methode <code>delete</code> (die de "Weet je het zeker?" pagina toont) en een methode <code>destroy</code> (die echt verwijdert). Beiden moeten beveiligd worden!
        </p>

        <pre><code class="language-php">
    /**
     * Hier bepalen we wie welke functie mag gebruiken.
     */
    public static function middleware(): array
    {
        return [
            // 1. Zien van de lijst (index)
            new Middleware(PermissionMiddleware::using('index category'), only:['index']),

            // 2. Bekijken van 1 item (show)
            new Middleware(PermissionMiddleware::using('show category'), only:['show']),

            // 3. Aanmaken (create toont formulier, store slaat op)
            new Middleware(PermissionMiddleware::using('create category'), only:['create', 'store']),

            // 4. Wijzigen (edit toont formulier, update slaat op)
            new Middleware(PermissionMiddleware::using('edit category'), only:['edit', 'update']),

            // 5. Verwijderen
            // We beveiligen de 'delete' (bevestigingspagina) EN de 'destroy' (actie)
            new Middleware(PermissionMiddleware::using('delete category'), only:['delete', 'destroy']),
        ];
    }
        </code></pre>

        <hr>

        <h2>Stap 3: De Frontend (Blade)</h2>
        <p>
            Als Sales nu probeert te verwijderen, krijgen ze een 403 error. Netter is om de knop helemaal niet te tonen.
            We gebruiken hiervoor <code>@can('permissie naam')</code>.
        </p>

        <p>Open <code>resources/views/admin/categories/index.blade.php</code>:</p>

        <pre><code class="language-html">
<thead>
    <tr>
        <th>Naam</th>
        <th>Acties</th>
    </tr>
</thead>

<tbody>
    @foreach($categories as $category)
        <tr>
            <td>{{ $category->name }}</td>
            <td class="flex gap-2">

                @can('show category')
                    <a href="{{ route('categories.show', $category) }}">Bekijk</a>
                @endcan

                @can('edit category')
                    <a href="{{ route('categories.edit', $category) }}">Wijzig</a>
                @endcan

                @can('delete category')
                    <a href="{{ route('categories.delete', $category) }}" class="text-red-500">
                        Verwijder
                    </a>
                @endcan

            </td>
        </tr>
    @endforeach
</tbody>
        </code></pre>

        <div class="info-box tip">
            <p><strong>Waarom Permissions en geen Roles?</strong><br>
                Je zou kunnen zeggen: <code>@role('admin')</code>. Maar wat als je later een "SuperManager" krijgt die het ook mag? Dan moet je je Blade-bestanden aanpassen.<br>
                Door permissies te checken (<code>@can('delete category')</code>), hoef je later alleen de rol in de database aan te passen. Je code blijft hetzelfde.</p>
        </div>

        <hr>

        <h2>Samenvatting</h2>
        <p>Je hebt nu een volledig gelaagde beveiliging:</p>
        <ol>
            <li><strong>Middleware op Route:</strong> Zorgt dat onbevoegden (Customers) niet bij `/admin` kunnen.</li>
            <li><strong>Middleware in Controller:</strong> Zorgt dat bevoegden (Sales) niet de bevestigingspagina (`delete`) of de actie (`destroy`) kunnen aanroepen.</li>
            <li><strong>Blade @can:</strong> Zorgt dat de interface zich aanpast aan de rechten van de gebruiker.</li>
        </ol>

    </main>

    <aside class="sidebar-right">
        <div class="toc-container">
            <h4>Inhoud</h4>
            <ul id="toc-list" class="toc-list">
            </ul>
        </div>
    </aside>
</div>

<div data-include="../../../../components/footer.html"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="../../../../assets/js/script.js"></script>
</body>
</html>