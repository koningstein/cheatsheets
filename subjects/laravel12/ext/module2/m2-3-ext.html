<!DOCTYPE html>
<html lang="nl" data-theme="light" data-color="red">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 2-3: Roles & Permissions (Spatie) - Laravel 12 Module 2</title>

    <script src="../../../../assets/js/theme-init.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="../../../../assets/css/style.css">
</head>
<body>

<div data-include="../../../../components/header.html"></div>

<div class="layout-wrapper">
    <div data-include="../../../../components/sidebar.html"></div>

    <main class="main-content">
        <h1>Module 2-3: Roles & Permissions (Spatie)</h1>

        <p class="lead">Tot nu toe is elke gebruiker in je applicatie gelijk. Maar in een echte webshop mag een klant alleen kopen, een magazijnmedewerker mag voorraden aanpassen, en een admin mag alles. We gaan dit regelen met <strong>Roles & Permissions</strong>.</p>

        <p>We bouwen dit niet zelf, want beveiliging is complex. We gebruiken de industriestandaard package: <strong>spatie/laravel-permission</strong>.</p>

        <section class="learning-outcomes">
            <h2>Leeruitkomsten</h2>
            <p>Na het afronden van deze les kun je:</p>
            <ul>
                <li>Een externe package installeren via Composer.</li>
                <li>De configuratie van een Laravel package publiceren en aanpassen.</li>
                <li>Een <strong>Trait</strong> toepassen in een Model om functionaliteit toe te voegen.</li>
                <li>Database Seeders gebruiken om een rechtenstructuur (Rollen & Permissies) op te zetten.</li>
            </ul>
        </section>

        <hr>

        <h2>Stap 1: De Package Installeren</h2>
        <p>
            We halen de code van de package binnen via <strong>Composer</strong>. Composer is de pakketmanager voor PHP; hij downloadt de bestanden naar je `vendor` map en zorgt dat je project weet dat deze nieuwe code bestaat.
        </p>
        <pre><code class="language-bash">composer require spatie/laravel-permission</code></pre>

        <hr>

        <h2>Stap 2: Configuratie & Database</h2>
        <p>
            Laravel moet weten dat we deze package willen gebruiken. Soms gaat dit automatisch, maar voor volledige controle voegen we de "Service Provider" handmatig toe. De Service Provider is het opstart-script van de package.
        </p>

        <h3>2.1 Provider registreren</h3>
        <p>
            Open <strong>bootstrap/providers.php</strong>. Dit bestand regelt welke onderdelen van Laravel worden opgestart. Voeg de regel van Spatie toe aan de lijst:
        </p>

        <pre><code class="language-php">return [
    App\Providers\AppServiceProvider::class,
    // Voeg deze regel toe:
    Spatie\Permission\PermissionServiceProvider::class,
];</code></pre>

        <h3>2.2 Bestanden Publiceren</h3>
        <p>
            De package heeft instellingen en database-migraties nodig. Deze zitten nu nog verstopt in de `vendor` map (die we nooit handmatig aanpassen). We moeten ze "publiceren" (kopiëren) naar jouw eigen projectmappen.
        </p>

        <pre><code class="language-bash">php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"</code></pre>

        <p>Dit commando zorgt voor twee dingen:</p>
        <ol>
            <li>Er komt een nieuw bestand: <code>config/permission.php</code> (hierin staan de instellingen).</li>
            <li>Er komt een nieuw migration-bestand in <code>database/migrations/</code>.</li>
        </ol>

        <h3>2.3 Migreren</h3>
        <p>De package heeft tabellen nodig om te onthouden wie welke rol heeft. Voer de migratie uit:</p>
        <pre><code class="language-bash">php artisan migrate</code></pre>

        <div class="info-box warning">
            <p><strong>Krijg je een MySQL error?</strong><br>
                Zie je een foutmelding zoals: <em>"Specified key was too long; max key length is 1000 bytes"</em>?<br>
                Dit gebeurt vaak bij oudere versies van MySQL. <br><br>
                <strong>Oplossing:</strong> Open <code>app/Providers/AppServiceProvider.php</code> en voeg dit toe in de <code>boot()</code> methode:
            <pre><code class="language-php">use Illuminate\Support\Facades\Schema; // Bovenaan toevoegen

public function boot(): void
{
    Schema::defaultStringLength(191);
}</code></pre>
            </p>
        </div>

        <hr>

        <h2>Stap 3: Het User Model Aanpassen</h2>
        <p>
            De tabellen zijn er, maar jouw <code>User</code> class snapt nog niet hoe hij met rollen moet praten. We moeten functionaliteit "injecteren" in het model. Dit doen we met een <strong>Trait</strong>.
        </p>
        <div class="info-box">
            <p><strong>Wat is een Trait?</strong><br>
                Een Trait is een setje kant-en-klare functies die je in een class kunt "plakken". Hierdoor krijgt jouw User opeens functies als <code>$user->assignRole('admin')</code> zonder dat je die zelf hoeft te schrijven.</p>
        </div>

        <p>Open <code>app/Models/User.php</code> en voeg de <code>HasRoles</code> trait toe:</p>

        <pre><code class="language-php">namespace App\Models;

// 1. Importeer de Trait
use Spatie\Permission\Traits\HasRoles;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    // 2. Activeer de Trait in de class
    use HasRoles;

    // ... de rest van je code ...
}</code></pre>

        <hr>

        <h2>Stap 4: Rollen & Rechten (Seeding)</h2>
        <p>
            Nu de techniek werkt, moeten we bepalen <em>wie</em> wat mag. Het is slim om dit in een <strong>Seeder</strong> vast te leggen. Waarom? Zodat je op elke computer (of als je de database reset) met één druk op de knop alle rechten weer goed hebt staan.
        </p>

        <h3>4.1 Seeder Maken</h3>
        <pre><code class="language-bash">php artisan make:seeder RoleAndPermissionSeeder</code></pre>

        <h3>4.2 Het verschil tussen Rol en Permissie</h3>
        <p>Voordat we de seeder vullen, is het belangrijk het verschil te snappen:</p>
        <ul>
            <li><strong>Permission (Permissie):</strong> Een hele specifieke actie. Bijvoorbeeld: <em>"artikel verwijderen"</em> of <em>"categorie bewerken"</em>.</li>
            <li><strong>Role (Rol):</strong> Een verzameling van permissies. Bijvoorbeeld: de rol <em>"Redacteur"</em> heeft de permissies om artikelen te schrijven én te bewerken.</li>
        </ul>

        <h3>4.3 Seeder Vullen</h3>
        <p>Open <code>database/seeders/RoleAndPermissionSeeder.php</code> en neem onderstaande code over. Lees de commentaren goed om te begrijpen wat er gebeurt.</p>

        <pre><code class="language-php">
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RoleAndPermissionSeeder extends Seeder
{
    public function run(): void
    {
        // 1. Reset de cache
        // Dit is heel belangrijk! Laravel onthoudt rechten om de site snel te houden.
        // Als je rechten aanpast, moet je die cache wissen, anders zie je de wijzigingen niet.
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();

        // 2. Maak de losse permissies aan (Wat kan er gedaan worden?)
        Permission::create(['name' => 'index category']);  // Lijst zien
        Permission::create(['name' => 'show category']);   // Details zien
        Permission::create(['name' => 'create category']); // Nieuwe maken
        Permission::create(['name' => 'edit category']);   // Aanpassen
        Permission::create(['name' => 'delete category']); // Verwijderen

        // 3. Maak ROLLEN aan en geef ze de juiste sleutels (permissies)

        // Rol: Sales (mag wel maken/wijzigen, maar NIET verwijderen)
        $roleSales = Role::create(['name' => 'sales']);
        $roleSales->givePermissionTo(['index category', 'show category', 'create category', 'edit category']);

        // Rol: Admin (mag ALLES)
        $roleAdmin = Role::create(['name' => 'admin']);
        $roleAdmin->givePermissionTo(Permission::all()); // Admin krijgt ALLE rechten in één keer
    }
}
        </code></pre>

        <h3>4.4 Seeder Koppelen</h3>
        <p>Laravel voert standaard alleen <code>DatabaseSeeder.php</code> uit. We moeten vertellen dat onze nieuwe seeder ook gedraaid moet worden.</p>
        <p>Open <code>database/seeders/DatabaseSeeder.php</code>:</p>
        <pre><code class="language-php">$this->call([
    RoleAndPermissionSeeder::class,
    // eventuele andere seeders...
]);</code></pre>

        <p>Voer tot slot de seed uit om alles in de database te zetten:</p>
        <pre><code class="language-bash">php artisan migrate:fresh --seed</code></pre>

        <hr>

        <h2>Samenvatting</h2>
        <p>
            Je hebt nu een professioneel rechtensysteem opgezet!
        </p>
        <ul>
            <li>Je hebt <code>spatie/laravel-permission</code> geïnstalleerd en geconfigureerd in <code>bootstrap/providers.php</code>.</li>
            <li>Je hebt je User model "slimmer" gemaakt met de <code>HasRoles</code> trait.</li>
            <li>Je hebt een structuur bedacht waarbij 'Sales' beperkte rechten heeft en 'Admin' alles mag.</li>
        </ul>
        <p>In de volgende les gaan we deze rollen gebruiken om knoppen in je Blade-bestanden te verbergen en routes te beveiligen.</p>

    </main>

    <aside class="sidebar-right">
        <div class="toc-container">
            <h4>Inhoud</h4>
            <ul id="toc-list" class="toc-list">
            </ul>
        </div>
    </aside>
</div>

<div data-include="../../../../components/footer.html"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="../../../../assets/js/script.js"></script>
</body>
</html>