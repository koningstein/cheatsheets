<!DOCTYPE html>
<html lang="nl" data-theme="light" data-color="blue">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtering (Where) & Joins - OOP PHP Module 8</title>

    <script src="../../../../assets/js/theme-init.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="../../../../assets/css/style.css">
</head>
<body>

<div data-include="../../../../components/header.html"></div>

<div class="layout-wrapper">
    <div data-include="../../../../components/sidebar.html"></div>

    <main class="main-content">
        <h1>Filtering: De WHERE Clausule</h1>

        <div class="info-box">
            <h3>Alles samenbrengen</h3>
            <p>In de vorige stap hebben we een <code>select</code> methode gebouwd die data uit meerdere tabellen kan halen (SELECT en FROM). Nu voegen we de onmisbare <strong>WHERE</strong> clausule toe.</p>
            <p>Dit stelt ons in staat om:</p>
            <ol>
                <li><strong>Relaties te leggen (Joins):</strong> "Koppel de score aan de juiste speler."</li>
                <li><strong>Te Filteren:</strong> "Toon alleen de speler met ID 5."</li>
                <li><strong>Te Zoeken:</strong> "Toon spelers waarvan de naam lijkt op 'King'."</li>
            </ol>
        </div>

        <h3>De Complete Select Methode</h3>
        <p>Hieronder zie je de volledige methode. Het eerste deel (SELECT/FROM) komt uit de vorige les. Het tweede deel (WHERE) is nieuw en handelt slim het verschil af tussen waarden (binding) en kolom-verwijzingen (literals).</p>

        <pre><code class="language-php">public function select(array $tableColumns, array $conditions = []): array
{
    // --- DEEL 1: SELECT & FROM (uit m8-4) ---
    $selectedColumns = [];
    $tableNames = [];

    foreach ($tableColumns as $table => $columns) {
        $tableNames[] = $table;
        foreach ($columns as $column) {
            if ($column === '*') {
                $selectedColumns[] = "$table.*";
            } else {
                $selectedColumns[] = "$table.$column";
            }
        }
    }

    $columnString = implode(', ', $selectedColumns);
    $tableString  = implode(', ', $tableNames);

    $sql = "SELECT $columnString FROM $tableString";
    $params = [];

    // --- DEEL 2: WHERE (Nieuw in m8-5) ---
    if (!empty($conditions)) {
        $whereParts = [];

        foreach ($conditions as $column => $value) {
            // 1. Operator detectie (bijv. 'points >' of 'name LIKE')
            // Als er geen spatie in de key zit, is het standaard '='
            $operator = strpos($column, ' ') ? '' : '=';

            // 2. Is de waarde een kolom-verwijzing? (Relatie/Join)
            // We checken op een punt (bijv. "players.id")
            if (is_string($value) && strpos($value, '.') !== false) {
                // GEEN binding: Directe SQL voor joins (scores.player_id = players.id)
                $whereParts[] = "$column $operator $value";
            }
            else {
                // 3. Het is een waarde: Binding gebruiken (Filter/Zoek)
                // Maak een unieke placeholder naam
                $safeCol = str_replace(['.', ' '], '_', $column);
                $paramName = ":" . $safeCol . "_" . count($params);

                $whereParts[] = "$column $operator $paramName";
                $params[$paramName] = $value;
            }
        }

        // Plak alles aan elkaar met AND
        $sql .= " WHERE " . implode(' AND ', $whereParts);
    }

    // --- DEEL 3: UITVOEREN ---
    $stmt = $this->connection->prepare($sql);
    $stmt->execute($params); // Bind de params array

    return $stmt->fetchAll();
}</code></pre>



        <h3>Voorbeelden van Gebruik</h3>

        <h4>1. Een Join (Relatie leggen)</h4>
        <p>Haal alle scores op mét de naam van de speler.</p>
        <pre><code class="language-php">$db->select(
    ['scores' => ['points'], 'players' => ['name']],
    // Join conditie: Waarde bevat een punt, dus wordt NIET gebind
    ['scores.player_id' => 'players.id']
);
// SQL: SELECT ... WHERE scores.player_id = players.id</code></pre>

        <h4>2. Specifiek Filteren</h4>
        <p>Haal gegevens op voor één speler.</p>
        <pre><code class="language-php">$db->select(
    ['players' => ['*']],
    // Filter conditie: Waarde is 5, dus wordt WEL gebind
    ['players.id' => 5]
);
// SQL: SELECT ... WHERE players.id = :players_id_0</code></pre>

        <h4>3. Zoeken met Operators</h4>
        <p>Zoek spelers met "King" in de naam.</p>
        <pre><code class="language-php">$db->select(
    ['players' => ['*']],
    // Operator LIKE zit in de key
    ['players.name LIKE' => '%King%']
);
// SQL: SELECT ... WHERE players.name LIKE :players_name_LIKE_0</code></pre>

        <div class="info-box">
            <h3>Samenvatting</h3>
            <ul>
                <li>We bouwen voort op de multi-table logica.</li>
                <li>De methode herkent automatisch of het een join is (bevat <code>.</code>) of een filterwaarde.</li>
                <li>Waarden worden altijd veilig gebind via Prepared Statements.</li>
            </ul>
        </div>

    </main>

    <aside class="sidebar-right">
        <div class="toc-container">
            <h4>Inhoud</h4>
            <ul id="toc-list" class="toc-list">
            </ul>
        </div>
    </aside>
</div>

<div data-include="../../../../components/footer.html"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="../../../../assets/js/script.js"></script>
</body>
</html>